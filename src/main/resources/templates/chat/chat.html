<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="chatView">
    <head>
        <meta charset="utf-8">
        <title>test</title>

        <!-- 2024-05-16, 채팅 기본 UI -->
        <link th:href="@{/css/chat/styles.less}" rel="stylesheet/less" type="text/css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/less.js/3.0.2/less.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <!-- 2024-05-17, 채팅방 Side Slide 기능 -->
        <link th:href="@{/css/chat/chat-slide.css}" rel="stylesheet" type="text/css"/>
        <script th:src="@{/js/chat/chat-slide.js}"></script>
        <!-- 2024-05-21, 채팅방 반응형 메뉴 버튼 구현 -->
        <link th:href="@{/css/chat/chat-skill-menu.css}" rel="stylesheet" type="text/css"/>
        <!-- 2024-05-27, 채팅방 검색 버튼 구현 -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <link th:href="@{/css/chat/chat-search.css}" rel="stylesheet" type="text/css"/>
        <!-- 2024-05-28, 채팅방 타임스탬프 구현 -->
        <link th:href="@{/css/chat/chat-timestamp.css}" rel="stylesheet" type="text/css"/>
        <!-- 2024-05-28, 채팅방 로딩 화면 구현 -->
        <link th:href="@{/css/chat/chat-loading.css}" rel="stylesheet" type="text/css"/>
        <!-- 2024-05-16, 채팅창 Drag UI 기능 -->
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
        <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
        <!-- 2024-05-17, 채팅방 대화상대 확인 -->
        <link th:href="@{/css/chat/chat-member-check.css}" rel="stylesheet" type="text/css"/>
        <!-- 2024-06-15, 채팅 버튼 -->
        <script th:src="@{/js/chat/font-awesome.js}"></script>
        <link th:href="@{/css/chat/chat-send-button.css}" rel="stylesheet" type="text/css"/>
        <!-- 2024-06-16, 토스트 메시지 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
        <!-- 2024-06-16, 이모티콘 박스 추가 -->
        <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@3.0.3/dist/index.min.js"></script>

        <!-- CSRF Token -->
        <meta name="_csrf" th:content="${_csrf.token}">
        <meta name="_csrf_header" th:content="${_csrf.headerName}">
    </head>

    <body>
    <!--<button id="opener">채팅하기</button>-->

    <div>
        <th:block th:with="pinfo=${#authentication.principal}">
            <input type="hidden" id="chat_user_id" th:value="${pinfo.userId}"/>
        </th:block>
        <div class="app-wrapp" style="left: -5px">
            <div class="app-container">
                <!-- @main page view -->
                <div class="view-main">
                    <div class="chat-room-mgr">
                        <th:block th:replace="~{chat/roomMgr :: roomMgrFragment}"/>
                    </div>
                    <div class="header-wrapp">
                        <div class="app-detail">
                            <div class="chat-profile-picture">
                                <span class="main-user-avatar">
                                    <span class="chat-profile-image">

                                    </span>
                                </span>
                            </div>
                            <div class="chat-profile-name"></div>
                            <div class="status chat-profile-dept"></div>
                        </div>
                        <!--                    <div class="wave-wrapp">-->
                        <!--                        <svg class="wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 24 150 28"-->
                        <!--                             preserveAspectRatio="none">-->
                        <!--                            <defs>-->
                        <!--                                <path id="gentle-wave"-->
                        <!--                                      d="m -160,44.4 c 30,0 58,-18 87.7,-18 30.3,0 58.3,18 87.3,18 30,0 58,-18 88,-18 30,0 58,18 88,18 l 0,34.5 -351,0 z"/>-->
                        <!--                            </defs>-->
                        <!--                            <g class="parallax">-->
                        <!--                                <use xlink:href="#gentle-wave" x="50" y="0" fill="rgba(255, 255, 255, 0.48)"/>-->
                        <!--                                <use xlink:href="#gentle-wave" x="50" y="3" fill="rgba(255, 255, 255, 0.78)"/>-->
                        <!--                                <use xlink:href="#gentle-wave" x="50" y="6" fill="rgba(255, 255, 255, 0.8)"/>-->
                        <!--                            </g>-->
                        <!--                        </svg>-->
                        <!--                    </div>-->
                    </div>
                    <div class="content-wrapp">
                        <div class="nav-group">
                            <nav id="master-nav">
                                <ul>
                                    <li><label class="nav-friend" title="사원">
                                        <i class="material-icons">3p</i></label></li>
                                    <li><label class="nav-chatting" title="채팅">
                                        <i class="material-icons">chat</i></label></li>
                                    <!-- <li><i class="material-icons">favorite_border</i></li> -->
                                    <li class="active"><label class="nav-profile" title="프로필">
                                        <i class="material-icons">account_box</i></label></li>
                                    <li id="active-line" style="left: 115px"></li>
                                </ul>
                            </nav>
                        </div>
                        <div id="master-nav-items" data-viewport="true">
                            <div id="item-1">
                                <div class="user-search-box">
                                    <input type="text" placeholder="검색" class="user-search-input">
                                    <div class="user-search-btn">
                                        <i class="material-icons user-search-icon">search</i>
                                    </div>
                                </div>
                                <div class="messages-list">
                                    <ul class="touch-y touch-employee">
                                        <!-- 채팅 사원 리스트 -->
                                    </ul>
                                </div>
                            </div>
                            <div id="item-2">
                                <div class="messages-list">
                                    <div class="chat-menu-container-mgr">
                                        <div class="list-container-mgr">
                                            <ul class="more-button-list more-button-list-mgr">
                                                <li class="more-button-list-item create-chat-room"
                                                    style="height: 50px;">
                                                    <i class="material-icons">meeting_room</i>
                                                    <span>채팅방 만들기</span>
                                                </li>
                                                <li class="more-button-list-item exit-chat-room" style="height: 50px;">
                                                    <i class="material-icons">logout</i>
                                                    <span>채팅방 나가기</span>
                                                </li>
                                            </ul>
                                            <button class="more-button-mgr mgr-menu" aria-label="Menu Button">
                                                <div class="menu-icon-wrapper">
                                                    <div class="menu-icon-line half first"></div>
                                                    <div class="menu-icon-line"></div>
                                                    <div class="menu-icon-line half last"></div>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                    <ul class="touch-y touch-chatroom">

                                    </ul>
                                </div>
                            </div>
                            <div id="item-3">
                                <div class="profile-setting">
                                    <div class="touch-y">
                                        <div class="information">
                                            <div class="public">
                                                <p>
                                                    프로필
                                                </p>
                                                <div class="form-group">
                                                    <span>
                                                        <i class="material-icons">account_circle</i>
                                                    </span>
                                                    <input type="text" name="chat_profile_id" placeholder="아이디" value=""
                                                           disabled>
                                                </div>
                                                <div class="form-group">
                                                    <span>
                                                        <i class="material-icons">person_pin</i>
                                                    </span>
                                                    <input type="text" name="chat_profile_name_input" placeholder="이름"
                                                           value="" disabled>
                                                </div>
                                                <div class="form-group h-80">
                                                    <span>
                                                        <i class="material-icons">textsms</i>
                                                    </span>
                                                    <textarea id="chat-profile-status-msg"
                                                              placeholder="상태메시지를 입력해주세요."
                                                              style="font-size: 12px"
                                                              rows="2" maxlength="30"></textarea>
                                                </div>
                                            </div>
                                            <div class="private">
                                                <p>
                                                    개인정보
                                                </p>
                                                <div class="form-group">
                                                    <span>
                                                        <i class="material-icons">contact_mail</i>
                                                    </span>
                                                    <input type="text" name="chat_profile_email" placeholder="이메일"
                                                           value="" disabled>
                                                </div>
                                                <div class="form-group">
                                                    <span>
                                                        <i class="material-icons">contact_phone</i>
                                                    </span>
                                                    <input type="text" name="chat_profile_phone" placeholder="전화번호"
                                                           value="" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- @send message view -->
                <div class="view-message">
                    <div class="chat-room-user-mgr">
                        <!--                        <th:block th:replace="~{chat/chatUserMgr :: chatUserMgrFragment}"/>-->
                    </div>
                    <div class="status-bar">
                        <div class="back-arrow">
                            <i class="material-icons">navigate_before</i>
                        </div>
                        <div class="mb-3 chat-room-info">
                            <div class="chat-room-name"></div>
                            <div class="chat-room-part-num">
                                <i class="material-icons chat-room-part-icon">person</i>
                                <span class="chat-room-part-count"></span>
                            </div>
                        </div>
                        <div class="chatroom-menu">
                            <a arial-label='Menu' class='menu-toggle' href='javascript:Display();'>
                                <i class="material-icons" style="font-size: 30px;" href='javascript:Display();'>menu</i>
                                <!-- <svg focusable='false' height='24' viewBox='0 0 24 24' width='24'>
                                    <path d='M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z' />
                                </svg> -->
                            </a>
                        </div>
                        <div class="chat-search-box">
                            <input type="text" placeholder="검색" class="chat-search-input">
                            <div class="chat-search-btn">
                                <i class="material-icons chat-search-icon">search</i>
                            </div>
                        </div>
                    </div>
                    <div class='darkshadow' style="width: 330px; height: 578px;"></div>
                    <nav id='nav-wrapper' style="display: none;">
                        <div class="main-container">
                            <div class="top-container">
                                <div class="top-content">
                                    <!-- <div class="back-arrow-nav" href='javascript:Display();'>
                                        <i class="material-icons">navigate_before</i>
                                    </div> -->
                                    <h1 class="nav-profile-h1"></h1>
                                    <span class="user-avatar">
                                        <span class="nav-profile-image">

                                        </span>
                                    </span>
                                </div>
                            </div>
                            <div class="scroll-wrapper">
                                <!-- Search Input -->
                                <div class="py-2 px-6 relative flex flex-col justify-center">
                                    <svg class="absolute left-10" xmlns="http://www.w3.org/2000/svg"
                                         style="width: 16px; height: 16px;" viewBox="0 0 16 16">
                                        <path class="fill-current text-gray-400"
                                              d="M6.4 1.6a4.8 4.8 0 100 9.6 4.8 4.8 0 000-9.6zm-4.525.275a6.4 6.4 0 019.58 8.45l4.31 4.31a.8.8 0 01-1.13 1.13l-4.31-4.31A6.399 6.399 0 010 6.4a6.4 6.4 0 011.875-4.525z"/>
                                    </svg>
                                    <input type="text" id="searchChatUser" placeholder="검색" x-ref="searchField"
                                           x-model="search"
                                           x-on:keydown.window.prevent.slash="$refs.searchField.focus()"
                                           class="border border-sky-100 rounded p-2 pl-10 placeholder-gray-300 outline-none hover:border-sky-200 focus:border-sky-200 focus:bg-sky-50 focus:bg-opacity-25"/>
                                </div>
                                <div id="user-scroller-container" class="activity-container">
                                    <div class=avatar-container>
                                        <span class="user-avatar offline small">
                                            <img th:src="@{/image/chat/default.png}">
                                        </span>
                                        <p>홍길동</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <ul>
                            <li>
                                <a class='nav-submenu' href='javascript:;' title='프로필'>
                                    <span>
                                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24"
                                             height="24" fill="currentColor" viewBox="0 0 24 24">
                                          <path fill-rule="evenodd"
                                                d="M17 10v1.126c.367.095.714.24 1.032.428l.796-.797 1.415 1.415-.797.796c.188.318.333.665.428 1.032H21v2h-1.126c-.095.367-.24.714-.428 1.032l.797.796-1.415 1.415-.796-.797a3.979 3.979 0 0 1-1.032.428V20h-2v-1.126a3.977 3.977 0 0 1-1.032-.428l-.796.797-1.415-1.415.797-.796A3.975 3.975 0 0 1 12.126 16H11v-2h1.126c.095-.367.24-.714.428-1.032l-.797-.796 1.415-1.415.796.797A3.977 3.977 0 0 1 15 11.126V10h2Zm.406 3.578.016.016c.354.358.574.85.578 1.392v.028a2 2 0 0 1-3.409 1.406l-.01-.012a2 2 0 0 1 2.826-2.83ZM5 8a4 4 0 1 1 7.938.703 7.029 7.029 0 0 0-3.235 3.235A4 4 0 0 1 5 8Zm4.29 5H7a4 4 0 0 0-4 4v1a2 2 0 0 0 2 2h6.101A6.979 6.979 0 0 1 9 15c0-.695.101-1.366.29-2Z"
                                                clip-rule="evenodd"/>
                                        </svg>채팅방 관리
                                    </span>
                                    <svg class='down' height='24'
                                         viewBox='0 0 24 24' width='24'>
                                        <path d='M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z'/>
                                    </svg>
                                </a>
                                <ul class='nav-sub'>
                                    <li>
                                        <a class="invite-chat-room-users" href='#' itemprop='url'>
                                        <span itemprop='name'>
                                            <svg style="margin-right: 0; display: inline-block;"
                                                 aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24"
                                                 height="24" fill="currentColor" viewBox="0 0 24 24">
                                                <path fill-rule="evenodd"
                                                      d="M9 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm-2 9a4 4 0 0 0-4 4v1a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1a4 4 0 0 0-4-4H7Zm8-1a1 1 0 0 1 1-1h1v-1a1 1 0 1 1 2 0v1h1a1 1 0 1 1 0 2h-1v1a1 1 0 1 1-2 0v-1h-1a1 1 0 0 1-1-1Z"
                                                      clip-rule="evenodd"/>
                                            </svg>
                                            대화상대 초대
                                        </span>
                                        </a>
                                    </li>
                                    <li>

                                        <a class="mgr-chat-room-users" href='#' itemprop='url'>
                                        <span itemprop='name'>
                                            <svg style="margin-right: 0; display: inline-block;"
                                                 aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24"
                                                 height="24" fill="currentColor" viewBox="0 0 24 24">
                                                <path fill-rule="evenodd"
                                                      d="M5 8a4 4 0 1 1 8 0 4 4 0 0 1-8 0Zm-2 9a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1Zm13-6a1 1 0 1 0 0 2h4a1 1 0 1 0 0-2h-4Z"
                                                      clip-rule="evenodd"/>
                                            </svg>
                                            유저 관리
                                        </span>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                <a href='#' itemprop='url' title='파일'>
                                    <span itemprop='name'>
                                        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24"
                                             height="24" fill="currentColor" viewBox="0 0 24 24">
                                            <path fill-rule="evenodd"
                                                  d="M21.707 21.707a1 1 0 0 1-1.414 0l-3.5-3.5a1 1 0 0 1 1.414-1.414l3.5 3.5a1 1 0 0 1 0 1.414ZM2 10a8 8 0 1 1 16 0 8 8 0 0 1-16 0Zm9-3a1 1 0 1 0-2 0v2H7a1 1 0 0 0 0 2h2v2a1 1 0 1 0 2 0v-2h2a1 1 0 1 0 0-2h-2V7Z"
                                                  clip-rule="evenodd"/>
                                        </svg>
                                        <button id="zoomButton">화면 크기 조절</button>
                                    </span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    <div class="list-container chat-menu-list">
                        <ul class="more-button-list">
                            <li class="more-button-list-item">
                                <i class="material-icons">event_note</i>
                                <span>일정</span>
                            </li>
                            <li class="more-button-list-item">
                                <i class="material-icons">sms_failed</i>
                                <span>공지사항</span>
                            </li>
                            <li id="emoji_btn" class="more-button-list-item">
                                <i class="material-icons">insert_emoticon</i>
                                <span>이모티콘</span>
                            </li>
                            <li id="sendFileBtn" class="more-button-list-item">
                                <i class="material-icons">file_upload</i>
                                <span>파일전송</span>
                                <input type="file" id="fileUpload" name="fileUpload" style="display: none;"/>
                            </li>
                        </ul>
                    </div>
                    <div class="list-container-chat chat-recive-menu">
                        <ul class="more-button-list more-button-list-chat">
                            <li class="more-button-list-item">
                                <i class="material-icons">file_download</i>
                                <span>다운로드</span>
                            </li>
                            <li class="more-button-list-item">
                                <i class="material-icons">error</i>
                                <span>신고하기</span>
                            </li>
                        </ul>
                    </div>
                    <div class="messages-area" data-viewport="true">
                        <input type="hidden" name="message_room_num" value=""/>
                        <div id="loading">
                            <div class="spinner"></div>
                        </div>
                        <ul id="chat-message-list" class="touch-y">
                            <li class="recive">
                                <div class="avatar-container">
                                    <span class="user-avatar offline small">
                                        <img th:src="@{/image/chat/default.png}">
                                    </span>
                                </div>
                                <p class="chat-nickname">대표님</p>
                                <div class="chat-content">
                                    자넨 해고일세
                                    <span>
                                        <strong class="chat-readcount">1</strong> 12:08 PM
                                    </span>
                                </div>
                            </li>
                            <li class="sent">
                                <div>
                                <span class="my-chat">
                                와우 신난다!
                                </span>
                                    <span>
                                    <strong class="my-chat-readcount">1</strong> 12:11 PM
                                </span>
                                </div>
                            </li>
                            <h5 class="chat-timestamp-dash">
                            <span class="chat-timestamp-content">
                                &nbsp;&nbsp;2024년 5월 28일 화요일&nbsp;&nbsp;
                            </span>
                            </h5>
                            <li class="sent">
                                <div>
                                    살려주세요..
                                    <span><strong class="my-chat-readcount">1</strong>1:11 AM</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="text-media-area">
                        <div class=message-form>
                            <button id='sendButton' class="chat-primary-button">
                                <div id='send' class='chat-send-button'>
                                    <i class="fa-solid fa-comment fa-xl"></i>
                                </div>
                                <div id='sending' class='chat-sending-button'></div>
                                <div id='sent' class='chat-sent-button'>
                                    <i class="fa-solid fa-check fa-xl"></i>
                                </div>
                            </button>
                            <input class="message-text" type="text" name="message-text" placeholder="채팅을 입력하세요."
                                   maxlength="150">
                            <div class="chat-menu-container">
                                <div class="list-container button-container">
                                    <button class="more-button skill-menu" aria-label="Menu Button">
                                        <div class="menu-icon-wrapper">
                                            <div class="menu-icon-line half first"></div>
                                            <div class="menu-icon-line"></div>
                                            <div class="menu-icon-line half last"></div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <style>
        img {
            display: inline-block;
            vertical-align: baseline;
        }
    </style>

    <script>
        $(document).ready(function () {
            /**
             * 2024-06-14, SSE 채팅방 리스트 새로고침
             */
            let eventSource = new EventSource("/chat/sse"); //http://localhost:9001/chat/sse
            let sseStatus = true;
            eventSource.addEventListener('chatListRoomRefresh', function (event) {
                if (event.data != '') {
                    if (sseStatus) {
                        getUserChatRoomList();
                        //console.log(event.data);
                    }
                }
            });

            let token = $("meta[name='_csrf']").attr("content");
            let header = $("meta[name='_csrf_header']").attr("content");

            let isChatRoom = false;
            var distX = 0, distY = 0;
            var viewportX, viewportY;
            $(document).on('mousedown touchstart', '.touch-y', function (e) {
                var $ele = $(this);
                viewportY = (-1 * $ele.height()) + viewport($ele).height();
                var startY = e.pageY || e.originalEvent.touches[0].pageY;
                var currentY = parseFloat($ele.css('transform').split(',')[5]);
                $(document).on('mousemove touchmove', function (e) {
                    e.preventDefault();
                    //console.log(distY);
                    $(".messages-list > ul > li").off('click');
                    var y = e.pageY || e.originalEvent.touches[0].pageY;
                    distY = y - startY;
                    if (currentY) {
                        distY += currentY;
                    }
                    if (distY > 3 || distY < (-3)) {
                        //$(".messages-list > ul > li").off('click');
                    }
                    $ele.css('transform', 'translateY(' + distY + 'px)');
                    if (distY > 0 || distY < viewportY) {
                        if (viewport($ele).find('.viewportShadow').length == 0)
                            viewport($ele).append('<span class="viewportShadow"></span>');
                    }
                    if (distY > 0) {
                        viewport($ele).find('.viewportShadow').css({
                            'top': '-5px',
                            'box-shadow': '0px 0px 140px ' + distY / 5 + 'px rgba(80,152,230,0.8)'
                        });
                    } else if (distY < viewportY) {
                        viewport($ele).find('.viewportShadow').css({
                            'bottom': '-5px',
                            'box-shadow': '0px 0px 140px ' + ((-1 * distY) + viewportY) / 5 + 'px rgba(80,152,230,0.8)'
                        });
                    }
                });
                $(document).on('mouseup touchend', function () {
                    $(document).off('mousemove touchmove mouseup touchend');
                    if (!distY) return;
                    if (distY > 0) {
                        if(isChatRoom == true) {
                            getChatMessages();
                        }
                        $ele.css('transform', 'translateY(0)').addClass("reset");
                        viewport($ele).find('.viewportShadow').css('box-shadow', '0 0 0 rgba(80,152,230,.5)');
                    } else if (distY < viewportY) {
                        if ($ele.height() > viewport($ele).height()) {
                            $ele.css('transform', 'translateY(' + viewportY + 'px)').addClass("reset");
                        } else {
                            $ele.css('transform', 'translateY(0)').addClass("reset");
                        }
                        viewport($ele).find('.viewportShadow').css('box-shadow', '0 0 0 rgba(80,152,230,.5)');
                    }
                    setTimeout(function () {
                        $ele.removeClass("reset");
                        viewport($ele).find('.viewportShadow').remove();
                        $(".messages-list > ul > li").off('click');
                        $(".messages-list > ul > li").bind('click', showMessages);
                    }, 200);
                });
            });

            function getChatMessages() {
                loadingStart();

                $.ajax({
                    type: "post",
                    url: "/chat/getChatMessages",
                    data: {
                        "chatRoomNum": messageRoomNum.val(),
                        "timeStamp": minTimeStamp
                    },
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (rdata) {
                        console.log(rdata);
                        //$("#chat-message-list").empty();
                        var output = '';
                        rdata.forEach(function (d, idx) {
                            var profileImage = "";

                            if (d.userProfilePicture != null) {
                                profileImage += "        <span class='user-avatar offline small'>";
                                profileImage += "            <img style='width:40px; height: 40px; border-radius: 50%;' src=" + d.userProfilePicture + " />";
                                profileImage += "        </span>"

                            } else {
                                profileImage += "        <span class='user-avatar offline small'>";
                                profileImage += "            <img style='width:40px; height: 40px; border-radius: 50%;' src='/image/chat/default.png' />";
                                profileImage += "        </span>"
                            }

                            if (d.chatRoomNum == 0) {
                                if (d.timeStamp != null) {
                                    output = "";
                                    output += "<h5 class='chat-timestamp-dash'>";
                                    output += "    <span class='chat-timestamp-content'>";
                                    output += "        &nbsp;&nbsp;" + getDayStr(d.timeStamp) + "&nbsp;&nbsp;";
                                    output += "    </span>";
                                    output += "</h5>";
                                }
                            } else if (d.senderId === $("#chat_user_id").val()) {
                                output = "";
                                output += "<li class='sent'>";
                                output += "    <div>";
                                output += "         <span class='my-chat'>";
                                output += d.messageContent;
                                if (d.fileUrl != null) {
                                    output += url;
                                }
                                output += "         </span>";
                                output += "         <span>";
                                output += "             <strong class='my-chat-readcount'> " + d.readCount + "&nbsp;</strong> " + getTime(d.sendTime);
                                output += "         </span>";
                                output += "    </div>";
                                output += "</li>";
                            } else {
                                output = "";
                                output += "<li class='recive'>";
                                output += "    <div class='avatar-container'>";
                                output += profileImage;
                                output += "    </div>"
                                output += "    <p class='chat-nickname'>" + d.username + "</p>";
                                output += "    <div class='chat-content'>";
                                output += d.messageContent;
                                if (d.fileUrl != null) {
                                    output += url;
                                }
                                output += "        <span>";
                                output += "            <strong class='chat-readcount'>" + d.readCount + "&nbsp;</strong>" + getTime(d.sendTime);
                                output += "        </span>";
                                output += "    </div>";
                                output += "</li>";
                            }
                            // idx 위치에 li 요소 추가
                            if (idx === 0) {
                                // 첫 번째 요소일 경우 prepend 사용
                                $("#chat-message-list").prepend(output);
                            } else {
                                // 그 외의 경우에는 특정 위치에 삽입
                                $("#chat-message-list .chat-timestamp-dash").eq(0).after(output);
                            }
                        });
                        setTimeout(function () {
                            $("#chat-message-list").css("transform", "translateY(0)");
                            // messageScrollFixChat();
                            loadingEnd();
                        }, 100);

                    }, // success end
                    error: function () {
                        //console.log('에러');
                        setTimeout(function () {
                            loadingEnd();
                        }, 100);
                    } // error end

                }) // ajax end
            }


            $(document).on('wheel', '.touch-y', function (e) {
                e.stopPropagation();
                //e.preventDefault();
                var $ele = $(this);
                var delta = e.originalEvent.deltaY;
                var currentY = parseFloat($ele.css('transform').split(',')[5]) || 0;
                var viewportY = (-1 * $ele.height()) + viewport($ele).height();
                var distY = currentY - delta;
                $ele.css('transform', 'translateY(' + distY + 'px)');
                if (distY > 0 || distY < viewportY) {
                    if (viewport($ele).find('.viewportShadow').length == 0)
                        viewport($ele).append('<span class="viewportShadow"></span>');
                }
                if (distY > 0) {
                    viewport($ele).find('.viewportShadow').css({
                        'top': '-5px',
                        'box-shadow': '0px 0px 140px ' + distY / 5 + 'px rgba(80,152,230,0.8)'
                    });
                } else if (distY < viewportY) {
                    viewport($ele).find('.viewportShadow').css({
                        'bottom': '-5px',
                        'box-shadow': '0px 0px 140px ' + ((-1 * distY) + viewportY) / 5 + 'px rgba(80,152,230,0.8)'
                    });
                }
                if (distY > 0) {
                    $ele.css('transform', 'translateY(0)').addClass("reset");
                    viewport($ele).find('.viewportShadow').css('box-shadow', '0 0 0 rgba(80,152,230,.5)');
                } else if (distY < viewportY) {
                    if ($ele.height() > viewport($ele).height()) {
                        $ele.css('transform', 'translateY(' + viewportY + 'px)').addClass("reset");
                    } else {
                        $ele.css('transform', 'translateY(0)').addClass("reset");
                    }
                    viewport($ele).find('.viewportShadow').css('box-shadow', '0 0 0 rgba(80,152,230,.5)');
                }
                setTimeout(function () {
                    //console.log('wheel');
                    $ele.removeClass("reset");
                    viewport($ele).find('.viewportShadow').remove();
                    //$(".messages-list > ul > li").off('click');
                    //$(".messages-list > ul > li").bind('click', showMessages);
                }, 200);
            });

            // Get viewport
            function viewport(ele) {
                return ele.closest('[data-viewport="true"]');
            }

            /** 2024-05-21, 네비게이션 툴팁 처리 */
            $(".nav-friend").tooltip();
            $(".nav-chatting").tooltip();
            $(".nav-profile").tooltip();

            // nav control
            var $el, leftPos, newWidth,
                $mainNav = $("#master-nav ul");
            var $active_line = $("#active-line");

            /**
             * 2024-05-31, 네이게이션 기본 위치 설정
             */
            //$active_line.css("left", $("#master-nav ul .active").position().left);
            $active_line.css("left", '115px');
            navItemPos($("#master-nav ul .active").index());
            $el = $("#master-nav ul li:eq(1)");
            $("#master-nav ul li").removeClass('active');
            $el.addClass('active');
            navItemPos($el.index());
            leftPos = $el.position().left;
            newWidth = $el.parent().width();

            /**
             * 2024-06-02, list 바인딩
             */
            setTimeout(function () {
                $(".messages-list > ul > li").off('click');
                $(".messages-list > ul > li").bind('click', showMessages);
            }, 1000);

            $("#master-nav ul li").click(function () {
                $el = $(this);
                $("#master-nav ul li").removeClass('active');
                $el.addClass('active');
                navItemPos($el.index());
                leftPos = $el.position().left;
                newWidth = $el.parent().width();
                $active_line.stop().animate({
                    left: leftPos
                });
            });

            function navItemPos(index) {
                $("#master-nav-items > div").removeClass("active after before");
                $("#master-nav-items > div").eq(index).addClass("active");
                $("#master-nav-items > div").eq(index).nextAll().addClass("after");
                $("#master-nav-items > div").eq(index).prevAll().addClass("before");
                $(".messages-list > ul > li").off('click', showMessages);
                $(".messages-list > ul > li").bind('click', showMessages);
            }

            /**
             * 2024-05-30, 채팅방 리스트와 사원 리스트 동작 분리
             */
            let messageRoomNum = $('input[name="message_room_num"]');

            function showMessages() {
                sseStatus = false;
                isChatRoom = true;

                var type = $(this).find('input[name=chat_room_type]').val();
                var chatRoomNum = '';
                var chatUserId = '';

                console.log('show message');
                //console.log(this);
                //console.log(type);

                if (type === 'p2p') { // 1대1 채팅방으로 접속 시
                    var chatCounterpartId = $(this).find('input[name=chat_counterpart_id]').val();
                    chatUserId = $("#chat_user_id").val();
                    isp2pChatRoom(chatCounterpartId, chatUserId, type);
                    chatRoomNum = messageRoomNum.val();
                    //console.log(chatCounterpartId);
                } else { // 채팅방 목록에서 접속 시
                    chatRoomNum = $(this).find('input[name=chat_room_num]').val();
                    chatUserId = $("#chat_user_id").val();
                    messageRoomNum.val(chatRoomNum); // 해당 방의 번호를 기억해놓습니다.
                    //console.log(chatRoomNum);
                }

                loadingStart();
                initChatRoomVisitTime(chatRoomNum, chatUserId); // 채팅방 방문 시간 업데이트
                getChatRoomInfo(chatRoomNum); // 채팅방 정보 가져오기 (채팅방 이름, 인원 수, 유저리스트)
                openChatRoom(chatRoomNum, chatUserId, type); // 웹소켓 연결 + 채팅 기록 가져오기
                setTimeout(function () {
                    loadingEnd();
                    messageScrollFix();
                }, 500);

                $('.view-main').addClass("deactive");
                $('.view-message').addClass("active");
                $(".user-search-box").css("display", "none");
                $(".chat-menu-container-mgr").css("display", "none");
                $(".app-detail").css("display", "none");
            }

            /**
             * 2024-06-15, 채팅방 방문 시간 업데이트
             */
            function initChatRoomVisitTime(chatRoomNum, chatUserId) {

                $.ajax({
                    type: "post",
                    url: "/chat/initChatRoomVisitTime",
                    data: {
                        "chatRoomNum": chatRoomNum,
                        "chatUserId": chatUserId
                    },
                    dataType: "json",
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (res) {
                        //console.log(res);
                    }
                }) // ajax end
            }

            /**
             * 2024-06-12, 채팅방 정보 가져오기 (채팅방 이름, 인원 수, 유저리스트)
             */
            function getChatRoomInfo(chatRoomNum) {
                $.ajax({
                    type: "post",
                    url: "/chat/getChatRoomInfo",
                    data: {
                        "chatRoomNum": chatRoomNum,
                        "chatUserId": $("#chat_user_id").val()
                    },
                    dataType: "json",
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (res) {

                        var $chatRoomName = $('.chat-room-name');
                        var $chatRoomPartCount = $('.chat-room-part-count');

                        $chatRoomName.html(res.roomName);
                        $chatRoomPartCount.html(res.userCount);

                        $(".activity-container").empty();
                        $(res.chatRoomPartList).each(function (index, item) {
                            //console.log(index);
                            let img = ''; // 이미지 처리 시
                            if (item.userProfilePicture != null) {
                                img = "<img style='width: 40px; height: 40px; border-radius: 50%;' src='" + item.userProfilePicture + "' />";
                            } else {
                                // 업로드된 프로필을 보여주도록 한다.
                                img = "<img style='width: 40px; height: 40px; border-radius: 50%;' src='/image/chat/default.png' />";
                            }
                            output = "";
                            output += "<div class='avatar-container'>";
                            output += "    <span class='user-avatar offline small'>";
                            output += "        " + img;
                            output += "    </span>";
                            output += "    <p>";
                            let userName = item.username;
                            if (userName.length >= 3) {
                                output += userName.substr(0, 3);
                            } else {
                                output += userName;
                            }
                            output += "     </p>";
                            output += "</div>";

                            $(".activity-container").append(output);
                        });

                    }
                }) // ajax end
            }

            /**
             * 2024-06-13, 사원 리스트에서 채팅을 클릭 시 1대1 채팅방이 있는지 확인한다.
             *             1 대 1 채팅방이 있는지 판별할 때는 상대방의 ID, 자신의 ID, 채팅방의 TYPE 으로 처리한다.
             *             1 대 1 채팅방이 없는 경우 정보를 토대로 1 대 1 채팅방을 생성해준다.
             */
            function isp2pChatRoom(chatCounterpartId, chatUserId, type) {
                $.ajax({
                    type: "post",
                    url: "/chat/isp2pChatRoom",
                    data: {
                        "chatCounterpartId": chatCounterpartId,
                        "chatUserId": chatUserId,
                        "type": type
                    },
                    dataType: "json",
                    async: false,
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (chatRoomNum) {
                        // console.log(chatRoomNum + '입니다.');
                        messageRoomNum.val(chatRoomNum);
                    }
                }) // ajax end
            }

            /**
             * 2024-06-08, 채팅방 입장
             */
            let ws;

            function openChatRoom(chatRoomNum, chatUserId, type) {
                //console.log(chatRoomNum);
                //console.log(chatUserId);
                //console.log(type);
                //console.log("wsOpen");
                wsOpen();

                function wsOpen() {
                    //웹소켓 전송시 현재 방의 번호를 넘겨서 보낸다.
                    ws = new WebSocket("ws://" + location.host + "/chatting/"
                        + chatRoomNum + "&" + chatUserId + "&" + type);
                    wsEvt();
                }

                function wsEvt() {
                    ws.onopen = function (data) {
                        //소켓이 열리면 동작
                        $("#chat-message-list").empty();
                    }

                    ws.onmessage = function (data) {
                        //메시지를 받으면 동작
                        var msg = data.data;
                        if (msg != null && msg.type !== '') {
                            //파일 업로드가 아닌 경우 메시지를 뿌려준다.
                            var d = JSON.parse(msg);
                            console.log(d);
                            //console.log(d.type);

                            if (d.userProfileImage != null) {
                                var profileImage = "";
                                profileImage += "        <span class='user-avatar offline small'>";
                                profileImage += "            <img style='width:40px; height: 40px; border-radius: 50%;' src=" + d.userProfileImage + " />";
                                profileImage += "        </span>";
                            } else {
                                var profileImage = "";
                                profileImage += "        <span class='user-avatar offline small'>";
                                profileImage += "            <img style='width:40px; height: 40px; border-radius: 50%;' src='/image/chat/default.png' />";
                                profileImage += "        </span>";
                            }

                            if (d.fileUrl != null) {
                                //console.log(d.fileUrl);
                                var url;
                                //url = "<img class='msgImg' style='width: 120px;' src='" + d.fileUrl + "'>"; // 이전

                                /**
                                 * 2024-06-16, 다운로드 이미지 UI 추가
                                 */
                                url = "<div class='group relative my-2.5'>";
                                url += "    <div class='absolute w-full h-full bg-gray-900/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg flex items-center justify-center'>";
                                url += "        <a href='" + d.fileUrl + "' download='" + d.fileOriginName + "' target='_blank' rel='noopener noreferrer'>";
                                url += "            <button data-tooltip-target='download-image' class='download-image-button inline-flex items-center justify-center ";
                                url += "                rounded-full h-10 w-10 bg-white/30 hover:bg-white/50 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50'>";
                                url += "                <svg class='w-5 h-5 text-white' aria-hidden='true' xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 16 18'>";
                                url += "                    <path stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' ";
                                url += "                        d='M8 1v11m0 0 4-4m-4 4L4 8m11 4v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3' />";
                                url += "                </svg>";
                                url += "            </button>";
                                url += "        </a>";
                                url += "        <div id='download-image' role='tooltip' class='absolute z-10 invisible inline-block px-3 py-2 ";
                                url += "            text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700'>";
                                url += "            Download image";
                                url += "            <div class='tooltip-arrow' data-popper-arrow></div>";
                                url += "        </div>";
                                url += "    </div>";
                                url += "    <img class='download-image rounded-lg' style='width: 120px;' src='" + d.fileUrl + "' alt='" + d.fileOriginName + "' />";
                                url += "</div>";
                            }

                            if (d.type === "getId") {
                                var si = d.sessionId != null ? d.sessionId : ""; // sessionId 가 널과 다르면 ""로 하라
                                if (si !== '') { // 가져오기
                                    if (d.timeStamp != null) {
                                        output = "";
                                        output += "<h5 class='chat-timestamp-dash'>";
                                        output += "    <span class='chat-timestamp-content'>";
                                        output += "        &nbsp;&nbsp;" + getDayStr(d.timeStamp) + "&nbsp;&nbsp;";
                                        output += "    </span>";
                                        output += "</h5>";

                                        $("#chat-message-list").append(output);
                                    } else if (d.sessionId === $("#chat_user_id").val()) {
                                        output = "";
                                        output += "<li class='sent'>";
                                        output += "    <div>";
                                        output += "         <span class='my-chat'>";
                                        output += d.msg;
                                        if (d.fileUrl != null) {
                                            output += url;
                                        }
                                        output += "         </span>";
                                        output += "         <span>";
                                        output += "             <strong class='my-chat-readcount'> " + d.readCount + "&nbsp;</strong> " + getTime(d.sendTime);
                                        output += "         </span>";
                                        output += "    </div>";
                                        output += "</li>";

                                        $("#chat-message-list").append(output);
                                    } else {
                                        output = "";
                                        output += "<li class='recive'>";
                                        output += "    <div class='avatar-container'>";
                                        output += profileImage;
                                        output += "    </div>"
                                        output += "    <p class='chat-nickname'>" + d.userName + "</p>";
                                        output += "    <div class='chat-content'>";
                                        output += d.msg;
                                        if (d.fileUrl != null) {
                                            output += url;
                                        }
                                        output += "        <span>";
                                        output += "            <strong class='chat-readcount'>" + d.readCount + "&nbsp;</strong>" + getTime(d.sendTime);
                                        output += "        </span>";
                                        output += "    </div>";
                                        output += "</li>";

                                        $("#chat-message-list").append(output);
                                    }
                                }
                            } else if (d.type === "message") { // 나의 메시지
                                if (d.sessionId === $("#chat_user_id").val()) {
                                    output = "";
                                    output += "<li class='sent goto'>";
                                    output += "    <div>";
                                    output += "         <span class='my-chat'>";
                                    output += d.msg;
                                    if (d.fileUrl != null) {
                                        output += url;
                                    }
                                    output += "         </span>";
                                    output += "         <span>";
                                    output += "             <strong class='my-chat-readcount'> " + d.readCount + "&nbsp;</strong> " + getTime(d.sendTime);
                                    output += "         </span>";
                                    output += "    </div>";
                                    output += "</li>";

                                    $("#chat-message-list").append(output);
                                    setTimeout(function () {
                                        $(document).find(".goto").removeClass("goto");
                                        messageScrollFixChat();
                                    }, 50);
                                } else {
                                    output = "";
                                    output += "<li class='recive goto'>";
                                    output += "    <div class='avatar-container'>";
                                    output += profileImage;
                                    output += "    </div>"
                                    output += "    <p class='chat-nickname'>" + d.userName + "</p>";
                                    output += "    <div class='chat-content'>";
                                    output += d.msg;
                                    if (d.fileUrl != null) {
                                        output += url;
                                    }
                                    output += "        <span>";
                                    output += "            <strong class='chat-readcount'>" + d.readCount + "&nbsp;</strong>" + getTime(d.sendTime);
                                    output += "        </span>";
                                    output += "    </div>";
                                    output += "</li>";

                                    $("#chat-message-list").append(output);
                                    setTimeout(function () {
                                        $(document).find(".goto").removeClass("goto");
                                        messageScrollFixChat();
                                    }, 50);
                                }
                            } else if (d.type === "imgurl") {
                                //파일 업로드한 경우 업로드한 파일을 채팅방에 뿌려준다.
                                if (d.sessionId === $("#chat_user_id").val()) {
                                    output = "";
                                    output += "<li class='sent goto'>";
                                    output += "    <div>";
                                    output += "         <span class='my-chat'>";
                                    output += d.msg;
                                    if (d.fileUrl != null) {
                                        output += url;
                                    }
                                    output += "         </span>";
                                    output += "         <span>";
                                    output += "             <strong class='my-chat-readcount'> " + d.readCount + "&nbsp;</strong> " + getTime(d.sendTime);
                                    output += "         </span>";
                                    output += "    </div>";
                                    output += "</li>";

                                    $("#chat-message-list").append(output);
                                    setTimeout(function () {
                                        $(document).find(".goto").removeClass("goto");
                                        messageScrollFixChat();
                                    }, 50);
                                } else {
                                    output = "";
                                    output += "<li class='recive goto'>";
                                    output += "    <div class='avatar-container'>";
                                    output += profileImage;
                                    output += "    </div>"
                                    output += "    <p class='chat-nickname'>" + d.userName + "</p>";
                                    output += "    <div class='chat-content'>";
                                    output += d.msg;
                                    if (d.fileUrl != null) {
                                        output += url;
                                    }
                                    output += "        <span>";
                                    output += "            <strong class='chat-readcount'>" + d.readCount + "&nbsp;</strong>" + getTime(d.sendTime);
                                    output += "        </span>";
                                    output += "    </div>";
                                    output += "</li>";

                                    $("#chat-message-list").append(output);
                                    setTimeout(function () {
                                        $(document).find(".goto").removeClass("goto");
                                        messageScrollFixChat();
                                    }, 50);
                                }
                            } else {
                                console.warn("unknown type!")
                            }
                        }
                    }
                }
            }

            var isRun = false;
            $(".back-arrow").click(function () {
                loadingStart();
                /**
                 * 2024-06-12, isRun을 통해 나가기 버튼 중복 동작 방지
                 */
                if (isRun == true) {
                    return false;
                }

                //console.log('back-arrow');
                isRun = true;
                sseStatus = true;
                isChatRoom = false;

                minTimeStamp = null;
                maxTimeStamp = null;
                minTime = null;
                maxTime = null;

                if (ws != null) {
                    ws.close();
                }

                let messageRoomNum = $('input[name="message_room_num"]');
                let chatUserId = $("#chat_user_id");
                initChatRoomVisitTime(messageRoomNum.val(), chatUserId.val()); // 채팅방 방문 시간 업데이트
                getChatUserList();
                getUserChatRoomList();
                getChatUserProfile();

                setTimeout(function () {
                    $(".view-main").removeClass("deactive");
                    $(".view-message").removeClass("active");
                    $("#chat-menu").css("display", "none");
                    $(".user-search-box").css("display", "block");
                    $(".chat-menu-container-mgr").css("display", "block");
                    $(".app-detail").css("display", "block");
                    $("#chat-message-list").css("transform", "translateY(0)");
                    $(".messages-list > ul > li").off('click', showMessages);
                    $(".messages-list > ul > li").bind('click', showMessages);
                    loadingEnd();
                    isRun = false;
                }, 100);
            });

            setInterval(function () {
                //console.log('showMessages bind');
                $(".messages-list > ul > li").off('click', showMessages);
                $(".messages-list > ul > li").bind('click', showMessages);
            }, 1000);

            $(document).keyup(function (e) {
                if (e.which == 13 && $('.view-message').hasClass("active")) {
                    sendMassage();
                }
            });

            function sendMassage() {
                //console.log('sendMessage');
                var message = $('input[name=message-text]').val();
                var chatUserId = $("#chat_user_id").val();

                if (message === '') {
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-start',
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer);
                            toast.addEventListener('mouseleave', Swal.resumeTimer);
                        }
                    })

                    Toast.fire({
                        icon: 'info',
                        title: '채팅을 입력해주세요.',
                        didOpen: (toast) => {
                            // 크기 조정
                            toast.style.width = '315px'; // 원하는 너비
                            toast.style.fontSize = '14px'; // 글자 크기 조정

                            // 위치를 px 단위로 조정
                            const offsetX = 0; // 원하는 x 위치
                            const offsetY = 50; // 원하는 y 위치

                            // 화면의 크기 가져오기
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;

                            // 요소의 크기 가져오기
                            const toastRect = toast.getBoundingClientRect();
                            const toastWidth = toastRect.width;
                            const toastHeight = toastRect.height;

                            // 화면 크기 내에서 위치 제한
                            const left = Math.min(offsetX, windowWidth - toastWidth); // 10px의 여유 공간
                            const top = Math.min(offsetY, windowHeight - toastHeight - 40); // 10px의 여유 공간

                            // 위치 설정
                            toast.style.position = 'fixed';
                            toast.style.left = `${left}px`;
                            toast.style.top = `${top}px`;
                        }
                    })
                    return false;
                } else {

                    var option = {
                        type: "message",
                        roomNumber: messageRoomNum.val(),
                        chatUserId: chatUserId,
                        msg: message
                    }

                    ws.send(JSON.stringify(option));
                    $(".message-text").val("");
                    return true;
                }
            }

            $("#sendFileBtn").click(function () {
                let myInput = document.getElementById("fileUpload");
                myInput.click();
            });

            $("#fileUpload").change(function (e) {
                fileSend();
            });

            function fileSend() {
                var file = document.querySelector("#fileUpload").files[0];
                var fileReader = new FileReader();

                fileReader.onload = function () {
                    var param = {
                        type: "fileUpload",
                        file: file,
                        fileName: file.name,
                        roomNumber: messageRoomNum.val(),
                        chatUserId: $("#chat_user_id").val(),
                        msg: ''
                    }

                    ws.send(JSON.stringify(param)); //파일 보내기전 메시지를 보내서 파일을 보냄을 명시한다.

                    arrayBuffer = this.result;
                    ws.send(arrayBuffer); //파일 소켓 전송
                };
                fileReader.readAsArrayBuffer(file);

                document.querySelector('.list-container').classList.toggle('active');
                document.querySelector('.button-container').classList.toggle('active');
            }

            /**
             * 2024-06-12, 날짜를 저장하는 변수 사용 예정
             * 사용 용도
             * 1. 가장 오래된 날짜를 기록하여 그 다음 날짜를 가져온다.
             * 2. 가장 최신 메시지의 날짜와 현재 날짜를 비교하여 다를 경우 타임스탬프를 메시지로 전송하여 저장
             * 2-1. Redis 이슈로 인해 날짜가 다른 경우 데이터를 입력 후 해딩 키 값을 리셋해준다.
             */


            // 주어진 날짜를 분할하여 Date 객체로 변환하는 함수
            function parseDate(dateStr) {
                //console.log(dateStr + ' 문자열');
                return new Date(dateStr).getTime();
            }

            let minTimeStamp = null;
            let maxTimeStamp = null;
            let minTime = null;
            let maxTime = null;

            function getDayStr(currentTimeStamp) {
                const currentTime = parseDate(currentTimeStamp);

                //console.log(currentTimeStamp + '현재 타임 스탬프');
                //console.log(currentTime + '현재 타임');
                //console.log(maxTimeStamp + '가장 최신 타임 스탬프');
                //console.log(minTimeStamp + '가장 오래된 타임 스탬프');
                //console.log(minTime + '가장 오래된 타임');
                //console.log(maxTime + '가장 최신 타임');

                // 처음에는 max와 min을 각각 현재 날짜로 초기화
                if (maxTimeStamp === null || currentTime > parseDate(maxTimeStamp)) {
                    maxTimeStamp = currentTimeStamp;
                    maxTime = currentTime;
                }

                if (minTimeStamp === null || currentTime < parseDate(minTimeStamp)) {
                    minTimeStamp = currentTimeStamp;
                    minTime = currentTime;
                }

                const arr = currentTimeStamp.split('-');
                dayStr = "";
                dayStr += arr[0] + "년 ";
                dayStr += arr[1] + "월 ";
                dayStr += arr[2] + "일 ";

                const dayOfWeek = new Date(currentTimeStamp).getDay();

                //0:일, 1:월, 2:화, 3:수, 4:목, 5:금, 6:토
                switch (dayOfWeek) {
                    case 0:
                        dayStr += "일요일";
                        break;
                    case 1:
                        dayStr += "월요일";
                        break;
                    case 2:
                        dayStr += "화요일";
                        break;
                    case 3:
                        dayStr += "수요일";
                        break;
                    case 4:
                        dayStr += "목요일";
                        break;
                    case 5:
                        dayStr += "금요일";
                        break;
                    case 6:
                        dayStr += "토요일";
                        break;
                }

                return dayStr;
            }

            function diffNowTime(time) {
                var lastMessageDayStr = `${new Date(time).getFullYear()}-${new Date(time).getMonth() + 1}-${new Date(time).getDate()}`;
                const todayStr = `${new Date().getFullYear()}-${new Date().getMonth() + 1}-${new Date().getDate()}`;
                //console.log(lastMessageDayStr);
                //console.log(todayStr);
                if (lastMessageDayStr === todayStr) {
                    return true;
                } else {
                    return false;
                }
            }

            function getDate(time) {
                var date = new Date(time);
                var lastMessageDayStr = `${new Date(time).getFullYear()}-${new Date(time).getMonth() + 1}-${new Date(time).getDate()}`;
                return lastMessageDayStr;
            }

            function getTime(time) {
                var date = new Date(time);
                var hours = date.getHours();
                var minutes = date.getMinutes();
                var ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                var strTime = hours + ':' + minutes + ' ' + ampm;
                return strTime;
            }

            function messageScrollFix() {
                setTimeout(function () {
                    var mes_hieght = parseInt($(".messages-area > ul").height());
                    var viewportHeight = parseInt($(".messages-area").height());
                    if (mes_hieght > viewportHeight)
                        $(".messages-area > ul").css("transform", "translateY(" + ((viewportHeight - mes_hieght) - 10) + "px)");
                }, 100);
            }

            function messageScrollFixChat() {
                setTimeout(function () {
                    var mes_hieght = parseInt($(".messages-area > ul").height());
                    var viewportHeight = parseInt($(".messages-area").height());
                    // var li_height = parseInt($(".messages-area > ul").children().last().height());
                    // var sent_height = parseInt($(".messages-area > ul").children().last().children('div').height());

                    if (mes_hieght > viewportHeight)
                        $(".messages-area > ul").css("transform", "translateY(" + ((viewportHeight - mes_hieght) - 10) + "px)");

                    //console.log('fix!');
                }, 250);
            }

            /**
             * 2024-05-16, 프로필 클릭 시 설정화면으로 이동
             */
            // $(".app-detail").click(function () {
            //     $el = $("#master-nav ul li:eq(2)");
            //     $("#master-nav ul li").removeClass('active');
            //     $el.addClass('active');
            //     navItemPos($el.index());
            //     leftPos = $el.position().left;
            //     newWidth = $el.parent().width();
            //     $active_line.stop().animate({
            //         left: leftPos
            //     });
            // });

            /** 2024-05-17, 채팅방 유저 검색 */
            $("#searchChatUser").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $(".activity-container .avatar-container").filter(function () {
                    //console.log($(this).find('p').text().toLowerCase().indexOf(value) > -1)
                    // toggle(true)는 선택한 요소를 보이도록 설정하는 메소드입니다.
                    // toggle(false)는 선택한 요소에 style="display: none;" 속성이 추가되어 보이지 않도록 합니다.
                    $(this).toggle($(this).find('p').text().toLowerCase().indexOf(value) > -1)
                });
            });

            /** 2024-05-17, 채팅방 유저 검색 */
            $(".user-search-input").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $(".touch-employee>li").filter(function () {
                    //console.log($(this).find('p').text().toLowerCase().indexOf(value) > -1)
                    // toggle(true)는 선택한 요소를 보이도록 설정하는 메소드입니다.
                    // toggle(false)는 선택한 요소에 style="display: none;" 속성이 추가되어 보이지 않도록 합니다.
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
                $(".touch-employee").css("transform", "translateY(0)");
            });

            /**
             * 2024-06-12, 채팅방 우측 스크롤 구현
             */
            const scrollContainer = document.getElementById('user-scroller-container');
            scrollContainer.addEventListener('wheel', (event) => {
                event.preventDefault();
                scrollContainer.scrollLeft += event.deltaY;
            });

            /**
             * 2024-05-31, Ajax 사원, 채팅방, 프로필 리스트 가져오기
             */
            getChatUserList();
            getChatUserProfile();
            getUserChatRoomList();

            /** 2024-05-28, 채팅방 유저 관리 화면, - 클릭 시 -> 유저 초대 목록 보여줌 */
            $(".invite-chat-room-users").click(function () {
                chatContentHidden();
                // 객체 형태로 파라미터 이름과 값을 전달합니다.
                const data = {
                    'type': 'chat-invite',
                    'name': '채팅방 초대',
                    'userButton': '초대',
                    "chatUserId": $("#chat_user_id").val(),
                    "chatRoomNum": $("input[name='message_room_num']").val()
                };
                chatRoomMgrAjax('/chat/chatUserInviteView', data, function (html) {
                    chatRoomUserDisplay(html);
                });
            });

            /** 2024-05-28, 채팅방 유저 관리 화면, - 클릭 시 -> 유저 추방 */
            $(".mgr-chat-room-users").click(function () {
                chatContentHidden();
                const data = {
                    'type': 'chat-mgr',
                    'name': '채팅방 관리',
                    'userButton': '추방',
                    "chatUserId": $("#chat_user_id").val(),
                    "chatRoomNum": $("input[name='message_room_num']").val()
                };
                chatRoomMgrAjax('/chat/chatUserMgrView', data, function (html) {
                    chatRoomUserDisplay(html);
                });
            });

            /** 2024-05-29, 채팅방 관리 화면,  채팅방 만들기 클릭 시 -> 채팅방 제목 입력 폼, 초대 가능한 유저 목록 보여줌 */
            $(".create-chat-room").click(function () {
                const data = {
                    'type': 'room-create',
                    'name': '대화상대 선택',
                    'roomButton': '방 초대',
                    "chatUserId": $("#chat_user_id").val()
                };
                chatRoomMgrAjax('/chat/chatRoomCreateView', data, function (html) {
                    chatRoomMgrDisplay(html);
                });
            });

            /** 2024-05-29, 채팅방 관리 화면,  채팅방 나가기 클릭 시 -> 나갈 채팅방 목록 보여줌 */
            $(".exit-chat-room").click(function () {
                const data = {
                    'type': 'room-exit',
                    'name': '채팅방 나가기',
                    'roomButton': '방 나가기',
                    "chatUserId": $("#chat_user_id").val()
                };
                chatRoomMgrAjax('/chat/chatRoomExitView', data, function (html) {
                    chatRoomMgrDisplay(html);
                });
            });

            /**
             * 채팅방 관리 - 공통 함수 분리 START
             */

            /**
             * 2024-05-28, 관리(채팅방,채팅방 유저) Ajax(요청 + 응답) 구현
             */
            function chatRoomMgrAjax(url, parameter, calbak) {
                $.ajax({
                    url: url,
                    data: parameter,
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    cache: false,
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                    success: function (html) {
                        calbak(html);
                    },
                    error: function (err) {
                        //console.log('error');
                        //calbak(err);
                    }
                })
            }

            /**
             * 2024-05-28, 채팅 화면 숨김 처리
             */
            function chatContentHidden() {
                $(".messages-area").css("display", "none");
                $(".text-media-area").css("display", "none");
            }

            /**
             * 2024-05-28, 채팅 유저 관리 화면 보여주기
             */
            function chatRoomUserDisplay(html) {
                //console.log("chat-room-user-mgr");
                $(".chat-room-user-mgr").empty();
                $(".chat-room-user-mgr").append(html);
                $(".chat-mgr-screen").fadeIn(500).css("display", "block");
            }

            /**
             * 2024-05-29, 채팅방 관리 화면 보여주기
             */
            function chatRoomMgrDisplay(html) {
                //console.log("chat-room-mgr");
                document.querySelector('.list-container-mgr').classList.toggle('active');
                $(".chat-room-mgr").empty();
                $(".chat-room-mgr").append(html);
                $(".mgr-room-screen").fadeIn(500).css("display", "block");
            }

            /**
             * 채팅방 관리 - 공통 함수 분리 END
             */

            /** 2024-05-21, 채팅방 기능 메뉴 클릭 시 */
            $("#send-message-file").click(function () {
                if ($("#chat-menu").css('display') === 'none') {
                    $("#chat-menu").menu();
                    $("#chat-menu").css("display", "block");
                    $("#chat-menu").css("position", "fixed");
                    $("#chat-menu").css("margin-left", "33px");
                    $("#chat-menu").css("margin-top", "-95px");
                    $("#chat-menu").css("z-index", "10");
                } else {
                    $("#chat-menu").css("display", "none");
                }
            });

            /** 2024-05-21, 채팅방 반응형 메뉴 버튼 구현 */
            document.querySelector('.skill-menu').addEventListener('click', function () {
                document.querySelector('.list-container').classList.toggle('active');
                document.querySelector('.button-container').classList.toggle('active');
            });

            /** 2024-05-21, 상대 채팅 클릭 시 다운로드, 신고하기 구현 */
            $(".recive").click(function () {
                document.querySelector('.list-container-chat').classList.toggle('active');
            });

            /** 2024-05-22, 채팅방 반응형 메뉴 버튼 구현 */
            document.querySelector('.mgr-menu').addEventListener('click', function () {
                document.querySelector('.list-container-mgr').classList.toggle('active');
            });

            /** 2024-05-27, 채팅방 검색 버튼 클릭 이벤트 구현 */
            var isSearchRun = true;
            $(".chat-search-btn").click(function () {

                if (isSearchRun == false) {
                    return false;
                }

                $(".chat-search-input").toggleClass("active").focus;
                $(this).toggleClass("animate");
                $(".chat-search-input").val("");
                isSearchRun = false;

                if ($('.chat-room-name').css('display') == 'none') {
                    $('.chat-room-name').fadeIn(300);
                    $('.chat-room-part-num').fadeIn(300);
                } else {
                    $('.chat-room-name').fadeOut(300);
                    $('.chat-room-part-num').fadeOut(300);
                }

                setTimeout(() => {
                    isSearchRun = true;
                }, 300);
            });

            /** 2024-05-27, 채팅방 검색 버튼 클릭 이벤트 구현 */
            var isUserSearchRun = true;
            $(".user-search-btn").click(function () {

                if (isUserSearchRun == false) {
                    return false;
                }

                $(".user-search-input").toggleClass("active").focus;
                $(this).toggleClass("animate");
                //$(".user-search-input").val("");
                isUserSearchRun = false;

                setTimeout(() => {
                    isUserSearchRun = true;
                }, 300);
            });

            /** 2024-05-28, 로딩 화면 구현 */
            /**
             * 화면 로딩 시작
             */
            function loadingStart() {
                const loading = document.querySelector('#loading');
                loading.style.display = 'block';
            }

            /**
             * 화면 로딩 종료
             */
            function loadingEnd() {
                const loading = document.querySelector('#loading');
                loading.style.display = 'none';
            }

            /**
             * 2024-05-29, getChatUserProfile 작업
             */
            function getChatUserProfile() {
                $.ajax({
                    type: "post",
                    url: "/chat/chatUserProfile",
                    data: {
                        "chatUserId": $("#chat_user_id").val()
                    },
                    dataType: "json",
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (rdata) {
                        //console.log(rdata);
                        if (rdata.userProfilePicture != null) {
                            img = "<img style='width: 50px; height: 50px;' src='" + rdata.userProfilePicture + "' />";
                        } else {
                            // 업로드된 프로필을 보여주도록 한다.
                            img = "<img style='width: 50px; height: 50px;' src='/image/chat/default.png' />";
                        }

                        var $chatProfilePicture = $('.chat-profile-image');
                        var $chatProfileName = $('.chat-profile-name');
                        var $chatProfileDept = $('.chat-profile-dept');
                        var $chatProfileId = $('input[name="chat_profile_id"]');
                        var $chatProfileNameInput = $('input[name="chat_profile_name_input"]');
                        var $chatProfileStatusMsg = $('#chat-profile-status-msg');
                        var $chatProfileEmail = $('input[name="chat_profile_email"]');
                        var $chatProfilePhone = $('input[name="chat_profile_phone"]');

                        var $chatNavProfileName = $('.nav-profile-h1');
                        var $chatNavProfilePicture = $('.nav-profile-image');


                        $chatProfilePicture.empty();
                        $chatProfilePicture.html(img);
                        $chatProfileName.html(rdata.username);
                        $chatProfileDept.html(rdata.departmentName);
                        $chatProfileId.val(rdata.userId);
                        $chatProfileNameInput.val(rdata.username);
                        $chatProfileStatusMsg.html(rdata.userChatStatusMsg);
                        $chatProfileEmail.val(rdata.userEmail);
                        $chatProfilePhone.val(rdata.userPhoneNumber);

                        if (rdata.userProfilePicture != null) {
                            img = "<img style='width: 40px; height: 40px; border-radius: 50%;' src='" + rdata.userProfilePicture + "' />";
                        } else {
                            // 업로드된 프로필을 보여주도록 한다.
                            img = "<img style='width: 40px; height: 40px; border-radius: 50%;' src='/image/chat/default.png' />";
                        }

                        $chatNavProfileName.html(rdata.username);
                        $chatNavProfilePicture.html(img);
                    }
                }) // ajax end
            }

            /**
             * 2024-05-29, getChatUserList 작업
             */
            function getChatUserList() {
                $.ajax({
                    type: "post",
                    url: "/chat/chatUserList",
                    data: {
                        "chatUserId": $("#chat_user_id").val()
                    },
                    dataType: "json",
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (rdata) {
                        //console.log(rdata);
                        //$(".touch-friend").show();
                        $(".touch-employee").empty();
                        let output = '';
                        $(rdata).each(function () {
                            let img = ''; // 이미지 처리 시
                            if (this.userProfilePicture != null) {
                                img = "<img style='width: 50px; height: 50px;' src='" + this.userProfilePicture + "' />";
                            } else {
                                // 업로드된 프로필을 보여주도록 한다.
                                img = "<img style='width: 50px; height: 50px;' src='/image/chat/default.png' />";
                            }

                            output += "<li>";
                            output += "    <input type='hidden' name='chat_counterpart_id' value='" + this.userId + "'/>";
                            output += "    <input type='hidden' name='chat_room_type' value='p2p'/>";
                            output += "    <div class='sender-image'>";
                            output += "       " + img;
                            output += "    </div>";
                            output += "    <div class='mes-detail'>";
                            if (this.userChatStatusMsg === null) { // 2024-06-02, chatStatusMsg로 변경 예정
                                output += "        <div class='mes-col1 chat-friend-list-col1' style='margin-top: 18px;'>";
                                output += "            <div class='sender-name'>";
                                output += "                " + this.departmentName + " - " + this.username;
                                output += "            </div>";
                                output += "        </div>";
                            } else {
                                output += "        <div class='mes-col1 chat-friend-list-col1'>";
                                output += "            <div class='sender-name'>";
                                output += "                " + this.departmentName + " - " + this.username;
                                output += "            </div>";
                                output += "            <div class='mes-preview'>";
                                output += "                " + this.userChatStatusMsg;
                                output += "            </div>";
                                output += "        </div>";
                            }

                            output += "    </div>";
                            output += "</li>";

                        }); // each end
                        $(".touch-employee").html(output);
                    }
                }) // ajax end
            }

            /**
             * 2024-05-29, getUserChatRoomList - 채팅방 리스트 가져오기
             */
            function getUserChatRoomList() {
                $.ajax({
                    type: "post",
                    url: "/chat/userChatRoomList",
                    data: {
                        "chatUserId": $("#chat_user_id").val()
                    },
                    dataType: "json",
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (res) {
                        //console.log(res);
                        let output = '';
                        res.forEach(function (d, idx) {
                            let img = ''; // 이미지 처리 시
                            if (d.roomType === '부서') {
                                img = "<img src='/image/chat/department.png' />";
                            } else if (d.roomType === '프로젝트') {
                                img = "<img src='/image/chat/project.png' />";
                            } else if (d.roomType === '팀') {
                                img = "<img src='/image/chat/team.png' />";
                            } else { // 자유
                                img = "<img src='/image/chat/default.png' />";
                            }

                            var roomNumber = d.chatRoomNum;
                            var sessionId = d.chatUserId;
                            var entryTime = d.chatEntryTime;
                            var visitTime = d.chatVisitTime;
                            var lastSendTime = d.lastSendTime;
                            var lastMessageContent = d.messageContent;
                            var roomName = d.roomName;
                            var roomCreateDate = d.roomCreateDate;
                            var unreadMessageCount = d.unreadMessageCount;

                            output += "<li>";
                            output += "<input type='hidden' name='chat_room_num' value='" + roomNumber + "' />";
                            output += "    <input type='hidden' name='chat_room_type' value='multi'/>";
                            output += "    <div class='sender-image'>";
                            output += "        " + img;
                            output += "    </div>";
                            output += "    <div class='mes-detail'>";
                            output += "        <div class='mes-col1'>";
                            output += "            <div class='sender-name'>";
                            output += "                " + roomName;
                            output += "            </div>";
                            output += "            <div class='mes-preview'>";
                            if (lastMessageContent != null) {
                                output += lastMessageContent.substr(0, 20);
                            }
                            output += "            </div>";
                            output += "        </div>";
                            output += "        <div class='mes-col2'>";
                            output += "            <div>";
                            if (lastSendTime != null) {
                                if (diffNowTime(lastSendTime)) {
                                    lastSendTime = getTime(lastSendTime);
                                    output += "                <div class='send-time'>" + lastSendTime + "</div>";
                                    output += "                <div class='mes-seen-status'>";
                                    output += "                <span class='new'>new</span>";
                                    output += "                </div>";
                                } else {
                                    lastSendTime = getDate(lastSendTime);
                                    output += "                <div class='send-time'>" + lastSendTime + "</div>";
                                }
                            }
                            output += "            </div>";
                            if (unreadMessageCount > 0) {
                                output += "            <span class='mes-count'>"
                                output += unreadMessageCount;
                                output += "            </span>";
                            }
                            output += "        </div>";
                            output += "    </div>";
                            output += "</li>";

                        }); // each end
                        $(".touch-chatroom").empty().html(output);
                    }
                }) // ajax end
            }

            /**
             * 2024-05-29, 상태 메시지 변경 구현
             */
            $('#chat-profile-status-msg').on('keyup', function () {
                var statusMsg = $("#chat-profile-status-msg").val();
                $.ajax({
                    type: "post",
                    url: "/chat/chatUserProfileMsg",
                    data: {
                        "chatUserId": $("#chat_user_id").val(),
                        "profileStatusMsg": statusMsg
                    },
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (rdata) {
                        //console.log(rdata);
                    }, // success end
                    error: function () {
                        //console.log('에러');
                    } // error end

                }) // ajax end

            });

            /**
             * 2024-06-15, 채팅 버튼 구현
             */
            //$("#sendButton").click(sendMassage);
            document.getElementById("sendButton").addEventListener("click", sendFunc, false);

            function sendFunc() {
                //document.getElementById("sendButton").removeEventListener ("click", sendFunc, false);
                const send = document.getElementById('send');
                const sending = document.getElementById('sending');
                const sent = document.getElementById('sent');
                const sendButton = document.getElementById('sendButton')

                if (sendMassage() == false) {
                    //console.log('false');
                    return false;
                }

                sending.style.opacity = 1;
                send.style.opacity = 0;
                sendButton.style.width = '35px';

                setTimeout(() => {
                    sending.style.opacity = 0;
                    sent.style.opacity = 1;
                }, 500);

                setTimeout(() => {
                    sent.style.opacity = 0;
                    send.style.opacity = 1;
                    sendButton.style.width = '35px';
                    document.getElementById("sendButton").addEventListener("click", sendFunc, false);
                }, 1000);
            }

            /**
             * 2024-06-16, 이모티콘 박스 처리
             */
            const emojiButton = document.querySelector("#emoji_btn");
            const picker = new EmojiButton({
                position: 'center-center'
            });

            emojiButton.addEventListener('click', () => {
                document.querySelector('.list-container').classList.toggle('active');
                document.querySelector('.button-container').classList.toggle('active');

                picker.togglePicker(emojiButton);

                // picker가 열릴 때 위치를 조정
                const emojiPickerElement = document.querySelector('.emoji-picker');
                if (emojiPickerElement) {
                    emojiPickerElement.style.position = 'fixed';
                    emojiPickerElement.style.width = '300px'; // 원하는 너비 조정
                    emojiPickerElement.style.height = '300px'; // 원하는 높이 조정
                    emojiPickerElement.style.bottom = '170px'; // 원하는 위치 조정
                    emojiPickerElement.style.left = '5px'; // 원하는 위치 조정
                    emojiPickerElement.style.zIndex = '99'; // 다른 요소 위에 표시되도록 z-index 설정
                }
            });

            picker.on('emoji', emoji => {
                const text_box = document.querySelector('.message-text');
                text_box.value += emoji;
            });

            /**
             * 2024-06-18, Full Text Index 검색
             */
            let isChatSave = false;
            $('.chat-search-input').on('keyup', function () {
                loadingStart();

                /**
                 * 2024-06-18, 검색 이전 데이터를 저장합니다.
                 */
                if (isChatSave == false) {
                    console.log($("#chat-message-list").children());
                    chatMessageListTemp = $("#chat-message-list").children();
                    isChatSave = true;
                }

                /**
                 * 2024-06-18, 검색 데이터가 빈('') 경우 원래 상태로 돌아갑니다.
                 */
                var messageContent = $(".chat-search-input").val();

                if(messageContent === '') {
                    $("#chat-message-list").empty();
                    $("#chat-message-list").append(chatMessageListTemp);
                    setTimeout(function () {
                        isChatSave = false;
                        $("#chat-message-list").css("transform", "translateY(0)");
                        messageScrollFixChat();
                        loadingEnd();
                    }, 100);
                    return false;
                }

                $.ajax({
                    type: "post",
                    url: "/chat/searchMessages",
                    data: {
                        "chatRoomNum":  messageRoomNum.val(),
                        "messageContent": messageContent
                    },
                    beforeSend: function (xhr) {
                        //데이터를 전송하기 전에 헤더에 csrf값을 설정합니다.
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (rdata) {
                        console.log(rdata);
                        $("#chat-message-list").empty();
                        var output = '';
                        rdata.forEach(function (d, idx) {
                            var profileImage = "";

                            if (d.userProfilePicture != null) {
                                profileImage += "        <span class='user-avatar offline small'>";
                                profileImage += "            <img style='width:40px; height: 40px; border-radius: 50%;' src=" + d.userProfilePicture + " />";
                                profileImage += "        </span>"

                            } else {
                                profileImage += "        <span class='user-avatar offline small'>";
                                profileImage += "            <img style='width:40px; height: 40px; border-radius: 50%;' src='/image/chat/default.png' />";
                                profileImage += "        </span>"
                            }

                            if (d.chatRoomNum == null) {
                                if (d.timeStamp != null) {
                                    output = "";
                                    output += "<h5 class='chat-timestamp-dash'>";
                                    output += "    <span class='chat-timestamp-content'>";
                                    output += "        &nbsp;&nbsp;" + getDayStr(d.timeStamp) + "&nbsp;&nbsp;";
                                    output += "    </span>";
                                    output += "</h5>";
                                }
                            } else if (d.senderId === $("#chat_user_id").val()) {
                                output = "";
                                output += "<li class='sent'>";
                                output += "    <div>";
                                output += "         <span class='my-chat'>";
                                output += d.messageContent;
                                if (d.fileUrl != null) {
                                    output += url;
                                }
                                output += "         </span>";
                                output += "         <span>";
                                output += "             <strong class='my-chat-readcount'> " + d.readCount + "&nbsp;</strong> " + getTime(d.sendTime);
                                output += "         </span>";
                                output += "    </div>";
                                output += "</li>";
                            } else {
                                output = "";
                                output += "<li class='recive'>";
                                output += "    <div class='avatar-container'>";
                                output += profileImage;
                                output += "    </div>"
                                output += "    <p class='chat-nickname'>" + d.username + "</p>";
                                output += "    <div class='chat-content'>";
                                output += d.messageContent;
                                if (d.fileUrl != null) {
                                    output += url;
                                }
                                output += "        <span>";
                                output += "            <strong class='chat-readcount'>" + d.readCount + "&nbsp;</strong>" + getTime(d.sendTime);
                                output += "        </span>";
                                output += "    </div>";
                                output += "</li>";
                            }
                            $("#chat-message-list").append(output);
                        });
                        setTimeout(function () {
                            $("#chat-message-list").css("transform", "translateY(0)");
                            messageScrollFixChat();
                            loadingEnd();
                        }, 100);

                    }, // success end
                    error: function () {
                        //console.log('에러');
                        $("#chat-message-list").empty();
                        $("#chat-message-list").append(chatMessageListTemp);
                        isChatSave = false;
                        setTimeout(function () {
                            loadingEnd();
                        }, 100);
                    } // error end

                }) // ajax end

            });

        });
    </script>
    </body>
</html>