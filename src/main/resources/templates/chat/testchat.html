<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <link th:href="@{/css/chattest/chat.css}" rel="stylesheet"/>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>Chating</title>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <style>
        @media screen and (max-width: 1200px) {
            * {
                margin: 0;
                padding: 0;
            }
        }

        @media screen and (max-width: 1200px) {
            html, body {
                height: 100%;
                overflow: auto;
            }
        }

        @media screen and (max-width: 1200px) {
            header {
                position: fixed;
                top: 0;
                /* width: 100% */
                left: 0;
                right: 0;

                /* 생략 */
            }
        }

        @media screen and (max-width: 1200px) {
            a {
                text-decoration: none;
                color: white;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: #0C66AC;
                padding: 8px 12px;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar-logo {
                font-size: 20px;
                color: white;
            }
        }

        @media screen and (max-width: 1200px) {
            p {
                font-size: 20px;
                font-weight: 50;
                color: white;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar-logo i {
                color: #d49466;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar_menu {
                display: flex;
                list-style: none;
                padding-left: 0;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar_menu li {
                padding: 8px 12px;
                color: white;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar_menu li:hover {
                background-color: #d49466;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar_icons {
                list-style: none;
                background-color: white;
                color: white;
                display: flex;
                padding-left: 0;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar_icons li {
                padding: 8px 12px;
            }
        }

        @media screen and (max-width: 1200px) {
            .navbar_toogleBtn {
                display: none;
                position: absolute;
                right: 32px;
                font-size: 24px;
                color: #d49466;
            }
        }

        @media screen and (max-width: 1200px) {
            @media screen and(max-width: 760px) {
                .navbar {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .navbar_menu {
                    display: none;
                    flex-direction: column;
                    align-items: center;
                    width: 100%;
                }

                .navbar_menu li {
                    width: 100%;
                    text-align: center;
                }

                .navbar_icons {
                    display: none;
                    justify-content: center;
                    width: 100%;
                }

                .navbar_toogleBtn {
                    display: block;
                }

                .navbar_menu.active, .navbar_icons.active {
                    display: flex;
                }
            }
        }

        @media screen and (max-width: 1200px) {
            body {
                margin: 0;
                padding: 0;
                font-weight: 400;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                font-size: 1rem;
                line-height: 1.58;
                color: #333;
                height: 100%;
            }
        }

        @media screen and (max-width: 1200px) {
            .container {
                left: 0;
                right: 0;
                text-align: center;
                margin-left: auto;
                margin-right: auto;
                background-color: #a2d0f2;
                position: relative;
                height: 90%;
            }
        }

        @media screen and (max-width: 1200px) {
            .container h1 {
                text-align: left;
                color: #000;
                text-align: center;
                vertical-align: middle;
                display: inline;
            }
        }

        @media screen and (max-width: 1200px) {
            .container h2 {
                text-align: left;
                padding: 0px 0px 0px 0px;
                color: #021422;
                text-align: center;
                display: inline;
            }
        }

        @media screen and (max-width: 1200px) {
            .chating {
                background-color: #9bbbd4;
                margin-left: auto;
                margin-right: auto;
                width: 100%;
                height: 85%;
                overflow: auto;
                position: relative;
            }
        }

        @media screen and (max-width: 1200px) {
            .chating::-webkit-scrollbar {
                width: 10px;
                display: none;
            }
        }

        @media screen and (max-width: 1200px) {
            .chatingr::-webkit-scrollbar {
                width: 10px;
                display: block;
            }
        }

        @media screen and (max-width: 1200px) {
            .chatingr::-webkit-scrollbar-thumb {
                background-color: #3681ba;
                display: block;
            }
        }

        @media screen and (max-width: 1200px) {
            .chatingr::-webkit-scrollbar-thumb:hover {
                background: #1869ab;
                display: block;
            }
        }

        @media screen and (max-width: 1200px) {
            .chatingr::-webkit-scrollbar-track {
                background-color: grey;
                box-shadow: inset 0px 0px 5px black;
                display: none;
            }
        }

        @media screen and (max-width: 1200px) {
            .chating::-webkit-scrollbar-button {
                display: none;
            }
        }

        @media screen and (max-width: 1200px) {
            .chating .me {
                color: #000;
                text-align: left;
            }
        }

        @media screen and (max-width: 1200px) {
            .chating .others {
                color: #000;
                text-align: left;
            }
        }

        @media screen and (max-width: 1200px) {
            input {
                width: 330px;
                height: 25px;
            }
        }

        @media screen and (max-width: 1200px) {
            .msgImg {
                width: 200px;
                height: 125px;
            }
        }

        @media screen and (max-width: 1200px) {
            .clearBoth {
                clear: both;
            }
        }

        @media screen and (max-width: 1200px) {
            .img {
                float: right;
            }
        }

        @media screen and (max-width: 1200px) {
            body:before {
                height: 100%;
                width: 100%;
                position: relative;
                top: 5%;
                left: 0;
                background: #fff;
                content: "";
                z-index: 0;
            }
        }

        @media screen and (max-width: 1200px) {
            .clearfix:after {
                display: block;
                content: "";
                clear: both;
            }
        }

        @media screen and (max-width: 1200px) {
            .hidden {
                display: none;
            }
        }

        @media screen and (max-width: 1200px) {
            .form-control {
                resize: none;
                margin-left: auto;
                margin-right: auto;
            }
        }

        @media screen and (max-width: 1200px) {
            input {
                padding-left: 10px;
                outline: none;
            }
        }

        @media screen and (max-width: 1200px) {
            h1 {
                font-size: 1.7em;
                background-color: #128ff2;
            }
        }

        @media screen and (max-width: 1200px) {
            h2 {
                font-size: 1.7em;
                background-color: #128ff2;
            }
        }

        /* h1, h2, h3, h4, h5, h6 {
            margin-top: 20px;
            margin-bottom: 20px;
        } */
        @media screen and (max-width: 1200px) {
            a {
                color: #128ff2;
            }
        }

        @media screen and (max-width: 1200px) {
            button {
                font-size: 14px;
                border: none;
                outline: none;
                line-height: 100%;
                white-space: nowrap;
                vertical-align: middle;
                border-radius: 0px;
                transition: all 0.2s ease-in-out;
                cursor: pointer;
            }
        }

        @media screen and (max-width: 1200px) {
            button.primary {
                background-color: #fff;
                color: #fff;
                width: calc(12% - 5px);
                height: 12%;
                min-height: 12%;
                margin-left: 0%;
            }
        }

        @media screen and (max-width: 1200px) {
            button.accent {
                margin: 10px 0px;
                background-color: #fff;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.12);
                color: #fff;
                width: 98%;
            }
        }

        @media screen and (max-width: 1200px) {
            button.accent2 {
                background-color: #fff;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.12);
                color: #fff;
                width: 98%;
            }
        }

        @media screen and (max-width: 1200px) {
            #username-page {
                text-align: center;
            }
        }

        @media screen and (max-width: 1200px) {
            .username-page-container {
                background: #fff;
                box-shadow: 0 1px 11px rgba(0, 0, 0, 0.27);
                width: 100%;
                max-width: 500px;
                display: inline-block;
                margin-top: 42px;
                vertical-align: middle;
                position: relative;
                padding: 35px 55px 35px;
                min-height: 200px;
                position: absolute;
                top: 50%;
                left: 0;
                right: 0;
                margin: 0 auto;
                margin-top: -160px;
            }
        }

        @media screen and (max-width: 1200px) {
            .username-page-container .username-submit {
                margin-top: 10px;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page {
                position: relative;
                height: 100%;
            }
        }

        @media screen and (max-width: 1200px) {
            .chatMessage-container {
                max-width: 100%;
                margin-left: auto;
                margin-right: auto;
                background-color: #fff;
                box-shadow: 0 1px 11px rgba(0, 0, 0, 0.27);
                height: 100%;
                position: relative;
                max-height: 95%;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page ul {
                list-style-type: none;
                background-color: #FFF;
                margin: 0;
                overflow: auto;
                overflow-y: scroll;
                padding: 0 20px 0px 20px;
                height: calc(100% - 150px);
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page #messageForm {
                padding: 20px;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page ul li {
                line-height: 1.5rem;
                padding: 10px 20px;
                margin: 0;
                border-bottom: 1px solid #f4f4f4;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page ul li p {
                margin: 0;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page .event-message {
                width: 100%;
                text-align: center;
                clear: both;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page .event-message p {
                color: #777;
                font-size: 14px;
                word-wrap: break-word;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page .chatMessage-message {
                padding-left: 68px;
                position: relative;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page .chatMessage-message i {
                position: absolute;
                width: 42px;
                height: 42px;
                overflow: hidden;
                left: 10px;
                display: inline-block;
                vertical-align: middle;
                font-size: 18px;
                line-height: 42px;
                color: #fff;
                text-align: center;
                border-radius: 50%;
                font-style: normal;
                text-transform: uppercase;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page .chatMessage-message span {
                color: #333;
                font-weight: 600;
            }
        }

        @media screen and (max-width: 1200px) {
            #chatMessage-page .chatMessage-message p {
                color: #43464b;
            }
        }

        @media screen and (max-width: 1200px) {
            #messageForm .input-group input {
                float: left;
                width: calc(100% - 85px);
                height: 100%;
            }
        }

        @media screen and (max-width: 1200px) {
            #messageForm .input-group button {
                float: left;
                width: 80px;
                height: 38px;
                margin-left: 5px;
            }
        }

        @media screen and (max-width: 1200px) {
            .chatMessage-header {
                background-color: #82c7fa;
                text-align: center;
                border-bottom: 1px solid #ececec;
                font-family: sans-serif;
                font-size: 200%;
            }
        }

        @media screen and (max-width: 1200px) {
            .connecting {
                padding-top: 5px;
                text-align: center;
                color: #777;
                position: absolute;
                top: 65px;
                width: 100%;
            }
        }

        @media screen and (max-width: 1200px) {
            .balloon_03 {
                position: relative;
                margin-top: 20px;
                margin-right: 20px;
                margin-left: 0px;
                margin-bottom: 20px;
                background: #fff;
                border-radius: 7px;
                text-align: left;
                max-width: 55%;
                float: left;
                padding-top: 0px;
                padding-right: 5px;
                padding-bottom: 0px;
                padding-left: 5px;
                font-size: 250%;
                overflow: hidden;
            }
        }

        @media screen and (max-width: 1200px) {
            .balloon_03_semo {
                margin-top: 5%;
                border-top: 13px solid #fff;
                border-left: 13px solid transparent;
                border-right: 0px solid transparent;
                border-bottom: 0px solid transparent;
                content: "";
                position: relative;
                top: 6px;
                left: 2px;
                float: left;
            }
        }

        @media screen and (max-width: 1200px) {
            .balloon_02 {
                margin-top: 3%;
                position: relative;
                max-width: 70%;
                background: #ede100;
                border-radius: 7px;
                text-align: left;
                float: right;
                padding-top: 0px;
                padding-right: 5px;
                padding-bottom: 0px;
                padding-left: 5px;
                display: table-row;
                margin-bottom: 3%;
                font-size: 250%;
                overflow: hidden;
            }
        }

        @media screen and (max-width: 1200px) {
            .balloon_semo {
                margin-top: 3%;
                border-top: 0px solid transparent;
                border-right: 14px solid transparent;
                border-left: 0px solid transparent;
                border-bottom: 14px solid #ede100;
                content: "";
                position: relative;
                float: right;
                top: 12px;
                right: 3px;
                margin-bottom: 3%;
            }
        }

        @media screen and (max-width: 1200px) {
            .block {
                width: 100%;
                height: 20%;
                max-height: 100%;
                display: table;
            }
        }

        @media screen and (max-width: 1200px) {
            .float {
                float: left;
                color: #000;
            }
        }

        @media screen and (max-width: 1200px) {
            .circle1 {
                background-color: #fef01b;
                width: 9%;
                height: 63px;
                top: 50px;
                border-radius: 20px;
                text-align: center;
                font-size: 20px;
                margin-left: 15px;
                margin-top: 10px;
                overflow: hidden;
            }
        }

        @media screen and (max-width: 1200px) {
            .textarea {
                resize: none;
                padding-left: 5px;
                font-size: 400%;
                height: 12%;
                min-height: 12%;
                width: 88%;
                vertical-align: middle;
                outline: none;
                border: none;
                text-decoration: none;
                font-family: Consolas, sans-serif;
                overflow: hidden;
            }
        }
    </style>
    <script>
        var ws;

        window.onload = function () {
            var userName = $("#userName").val();
            setInterval(function () {
                $(".chating").removeClass('chatingr');
            }, 7000);
            wsOpen()
        }

        $(function () {
            $(".chating").on('mousewheel DOMMouseScroll', function (e) {
                var E = e.originalEvent;

                if (E.detail) {
                    $('.chating').addClass('chatingr');
                } else {
                    $('.chating').addClass('chatingr');
                }

            });
        });

        function wsOpen() {
            //웹소켓 전송시 현재 방의 번호를 넘겨서 보낸다.
            ws = new WebSocket("ws://" + location.host + "/chating/"
                + $("#roomNumber").val() + "&" + $("#userName").val());
            wsEvt();
        }

        function wsEvt() {
            ws.onopen = function (data) {
                //소켓이 열리면 동작
            }

            ws.onmessage = function (data) {
                //메시지를 받으면 동작
                var msg = data.data;
                if (msg != null && msg.type != '') {
                    //파일 업로드가 아닌 경우 메시지를 뿌려준다.
                    var d = JSON.parse(msg);
                    console.log(d.type);

                    var url;
                    if (d.fileUrl != '') {
                        url = "<img class='msgImg' src='" + d.fileUrl + "'>";
                    }

                    if (d.type == "getId") {
                        var si = d.sessionId != null ? d.sessionId : ""; // sessionId 가 널과 다르면 ""로 하라
                        if (si != '') { // 가져오기
                            if (d.userName == $("#userName").val()) {
                                $("#chating").append(
                                    "<div class='block'><p class='balloon_semo'></p><p class='me balloon_02'>"
                                    + d.msg +
                                    + url +
                                    "</p></div>");
                                $("#chating").scrollTop(
                                    $("#chating")[0].scrollHeight);
                            } else {
                                $("#chating")
                                    .append(
                                        "<div class='block'><p class='float circle1' style='background-repeat:no-repeat;background-position:bottom center; background-size: 35px;'>"
                                        + d.userName
                                            .substring(0, 1)
                                        + "</p><p class='balloon_03_semo float'><p class='others balloon_03 float'>"
                                        + d.msg +
                                        + url +
                                        "</p></div>");
                                $("#chating").scrollTop(
                                    $("#chating")[0].scrollHeight);
                            }
                        }
                    } else if (d.type == "message") { // 평소 처리
                        if (d.userName == $("#userName").val()) {
                            $("#chating").append(
                                "<div class='block'><p class='balloon_semo'></p><p class='me balloon_02'>"
                                + d.msg + "</p></div>");
                            $("#chating").scrollTop($("#chating")[0].scrollHeight);
                        } else {
                            $("#chating")
                                .append(
                                    "<div class='block'><p class='float circle1' style='background-repeat:no-repeat;background-position: center; background-size: 35px;'>"
                                    + d.userName.substring(0, 1)
                                    + "</p><p class='balloon_03_semo float'><p class='others balloon_03 float'>"
                                    + d.msg + "</p></div>");
                            $("#chating").scrollTop($("#chating")[0].scrollHeight);
                        }

                    } else if (d.type == "imgurl")  {
                        //파일 업로드한 경우 업로드한 파일을 채팅방에 뿌려준다.
                        var url = d.imageurl;
                        if (d.userName == $("#userName").val()) {
                            $("#chating").append(
                                "<div class='block'><p class='balloon_semo'></p><p class='me balloon_02'>"
                                + "<img class='msgImg' src='" + url + "'>" + "</p></div>");
                            $("#chating").scrollTop($("#chating")[0].scrollHeight);
                        } else {
                            $("#chating")
                                .append(
                                    "<div class='block'><p class='float circle1' style='background-repeat:no-repeat;background-position: center; background-size: 35px;'>"
                                    + d.userName.substring(0, 1)
                                    + "</p><p class='balloon_03_semo float'><p class='others balloon_03 float'>"
                                    + "<img class='msgImg' src='" + url + "'>" + "</p></div>");
                            $("#chating").scrollTop($("#chating")[0].scrollHeight);
                        }
                    } else {
                        console.warn("unknown type!")
                    }
                }
            }

            document.addEventListener("keypress", function (e) {
                if (e.keyCode == 13) { //enter press
                    send();
                    setColor()
                }
            });

            document.addEventListener("keyup", function (e) {
                if (e.keyCode != 13) { //enter press
                    adjustHeight();
                    setColor();
                } else {
                    $('.form-control').val("");
                    adjustHeight();
                    setColor();
                }
            });
        }

        function send() {
            if ($('#chatting').val() == '') {
                alert('채팅을 입력해주세요.');
            } else {
                var option = {
                    type: "message",
                    roomNumber: $("#roomNumber").val(),
                    userName: $("#userName").val(),
                    msg: $("#chatting").val()
                }
                ws.send(JSON.stringify(option))
                $('.form-control').val("");
            }

        }

        function adjustHeight() {
            var textEle = $('textarea');
            var btn = $('.primary');
            textEle[0].style.height = 'auto';
            var textEleHeight = textEle.prop('scrollHeight');
            textEle.css('height', textEleHeight);
            btn.css('height', textEleHeight);
        };

        function setColor() {

            if ($('#chatting').val() == '') {
                var btn = document.getElementById("sendBtn");
                var color = ["#ffffff"];
                //btn.style.backgroundColor = color;
                btn.style.backgroundColor = color[0];
                btn.style.backgroundImage = "none";

            } else {
                var btn = document.getElementById("sendBtn");
                var color = ["#fef01b"];
                //btn.style.backgroundColor = color;
                btn.style.backgroundColor = color[0];
                btn.style.backgroundImage = "url('<c:url value='/resources/img/kakao_paper.PNG'/>')";
            }

        };

        function chkword(obj, maxlength) {
            var str = obj.value; // 이벤트가 일어난 컨트롤의 value 값
            var str_length = str.length; // 전체길이       // 변수초기화
            var max_length = maxlength; // 제한할 글자수 크기
            var i = 0; // for문에 사용
            var ko_byte = 0; // 한글일경우는 2 그밗에는 1을 더함
            var li_len = 0; // substring하기 위해서 사용
            var one_char = ""; // 한글자씩 검사한다
            var str2 = ""; // 글자수를 초과하면 제한할수 글자전까지만 보여준다.
            for (i = 0; i < str_length; i++) { // 한글자추출
                one_char = str.charAt(i);
                ko_byte++;
            } // 전체 크기가 max_length를 넘지않으면
            if (ko_byte <= max_length) {
                li_len = i + 1;
            } // 전체길이를 초과하면
            if (ko_byte > max_length) {
                alert(max_length + " 글자 이상 입력할 수 없습니다. \n 초과된 내용은 자동으로 삭제 됩니다. ");
                str2 = str.substr(0, max_length);
                obj.value = str2;
            }
            obj.focus();
        }

        /* var textEle = $('textarea');
         textEle.on('keyup', function() {
         adjustHeight();
         }); */

        function fileSend() {
            var file = document.querySelector("#fileUpload").files[0];
            var fileReader = new FileReader();

            console.log();

            fileReader.onload = function () {
                var param = {
                    type: "fileUpload",
                    file: file,
                    fileName: file.name,
                    roomNumber: $("#roomNumber").val(),
                    sessionId: $("#sessionId").val(),
                    msg: $("#chatting").val(),
                    userName: $("#userName").val()
                }

                ws.send(JSON.stringify(param)); //파일 보내기전 메시지를 보내서 파일을 보냄을 명시한다.

                arrayBuffer = this.result;
                ws.send(arrayBuffer); //파일 소켓 전송
            };
            fileReader.readAsArrayBuffer(file);
            adjustHeight();
        }
    </script>
</head>
<body>
<!--
<div id="container" class="container">
    <h1>${roomName}의채팅방</h1>
    <input type="hidden" id="roomNumber" value="${roomNumber}">

    <div id="chating" class="chating"></div>

    <div id="yourName">
        <table class="inputTable">
            <tr>
                <th><input type="hidden" name="userName" id="userName"
                    value="${member.id}"></th>
            </tr>
        </table>
    </div>
    <div id="yourMsg">
        <table class="inputTable">
            <tr>
                <th>메시지</th>
                <th><input id="chatting" placeholder="보내실 메시지를 입력하세요."></th>
                <th><button onclick="send()" id="sendBtn">보내기</button></th>
            </tr>
            <tr>
                <th>파일업로드</th>
                <th><input type="file" id="fileUpload"></th>
                <th><button onclick="fileSend()" id="sendFileBtn">파일올리기</button></th>
            </tr>
        </table>
    </div>
</div>
-->

<div class="chatMessage-container">
    <div class="chatMessage-header">
        <h1>문의</h1>
    </div>
    <div id="container" class="container">
        <h2 style="font-size: 250%;">[[${roomName}]]</h2>
        <th:block th:with="pinfo=${#authentication.principal}">
            <input type="hidden" id="userName" name="userName"
                   th:value="${pinfo.username}">
        </th:block>
        <input type="hidden" id="roomNumber" th:value="${roomNumber}">
        <div id="chating" class="chating" style='background-repeat:no-repeat;background-position: center;'>
            <!-- style='background-image: url('');background-repeat:no-repeat;background-position: center;'-->
        </div>

        파일업로드
        <input type="file" id="fileUpload">
        <button onclick="fileSend()" id="sendFileBtn">파일올리기</button>

        <textarea rows="1" id="chatting" class="float textarea form-control"
                  placeholder="Type a message..." onkeyup="chkword(this,150)"></textarea>
        <button class="primary float" onclick="send()" id="sendBtn"
                style='background-repeat: no-repeat;background-position: center;'>
        </button>

    </div>
</div>
</body>
</html>